<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cloud Manager</title>
    <!-- Шрифты: Manrope для заголовков, JetBrains Mono для данных -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Manrope:wght@400;500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://st.max.ru/js/max-web-app.js"></script>
</head>

<body>
    <div class="noise-overlay"></div>

    <div class="container">
        <!-- БЛОК СИСТЕМНЫХ СООБЩЕНИЙ -->
        <!-- Вынесен в отдельный контейнер для идеального отступа -->
        <div class="alert-container">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, msg in messages %}
            <div class="alert {{ category }}">
                <!-- Иконка зависит от типа -->
                <span class="alert-icon">
                    {% if category == 'success' %}●
                    {% elif category == 'error' %}✖
                    {% else %}ℹ{% endif %}
                </span>
                <span class="alert-text">{{ msg }}</span>
            </div>
            {% endfor %}
            {% endif %}
            {% endwith %}
        </div>

        {% if not is_authed %}
        <!-- ЛОГОТИП И ЗАГОЛОВОК -->
        <div class="app-header">
            <div class="app-logo">
                <img src="{{ url_for('static', filename='bot.png') }}" alt="System Logo">
            </div>
            <h1>Cloud Manager</h1>
            <div class="app-subtitle">Terminal Access v2.0</div>
        </div>

        <!-- КАРТОЧКА АВТОРИЗАЦИИ -->
        <div class="card auth-card page-transition active">

            <!-- Keycloak (Dominant Action) -->
            <button class="btn btn-keycloak js-auth-btn" type="button" data-provider="Keycloak"
                data-url="{{ url_for('keycloak_oauth_init') }}">
                <span class="btn-icon">
                    <!-- Иконка замка/ключа -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M15 12H3" />
                    </svg>
                </span>
                Войти через SSO
            </button>

            <div class="auth-divider">
                <span>System Login</span>
            </div>

            <!-- Форма входа -->
            <form action="{{ url_for('login') }}" method="POST" class="auth-form">
                <div class="form-group">
                    <label class="form-label" for="login">User ID</label>
                    <div class="input-wrapper">
                        <input id="login" name="login" type="text" class="input-field" placeholder="username" required
                            autocomplete="username">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="password">Access Key</label>
                    <div class="input-wrapper">
                        <input id="password" name="password" type="password" class="input-field" placeholder="••••••"
                            required autocomplete="current-password">
                    </div>
                </div>
                <button class="btn btn-primary" type="submit">
                    <span class="btn-icon">→</span> Подключиться
                </button>
            </form>
        </div>

        {% else %}
        <!-- ВНУТРЕННИЙ ИНТЕРФЕЙС -->
        <div class="app-header">
            <div class="app-logo">
                <img src="{{ url_for('static', filename='bot.png') }}" alt="App Logo">
            </div>
            <h1 id="headerTitle">Меню</h1>
            <div class="app-subtitle">Session Active: {{ user_info.name }}</div>
        </div>

        <!-- Главное меню -->
        <div class="page-transition active" id="menuSection">
            <div class="choice-grid">
                <div class="choice-card" data-action="resources">
                    <div class="choice-title">Ресурсы</div>
                    <div class="choice-desc mono-font">Статус кластеров и квоты</div>
                </div>
                <div class="choice-card" data-action="create">
                    <div class="choice-title">Развернуть</div>
                    <div class="choice-desc mono-font">Создать новый инстанс</div>
                </div>
            </div>

            <div class="logout-container">
                <form action="{{ url_for('logout') }}" method="POST">
                    <button class="btn btn-secondary" type="submit">
                        <span class="btn-icon">×</span> Завершить сеанс
                    </button>
                </form>
            </div>
        </div>
        <!-- Привожу пример для Resources, чтобы показать структуру -->
        <div class="card hidden page-transition" id="resourcesSection">
            <h1 class="section-title">Системные данные</h1>
            <div class="user-info-container">
                <div class="form-group">
                    <label class="form-label">User Identity</label>
                    <div class="info-value mono-font">{{ user_info.name }}</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Handle</label>
                    <div class="info-value mono-font">{{ user_info.email }}</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Project ID</label>
                    <div class="info-value mono-font">{{ user_info.cloud_project_id }}</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Active Instances</label>
                    <div class="info-value mono-font" id="vmCount">
                        <span class="spinner vm-spinner"></span>
                    </div>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary back-to-menu-btn" type="button">
                    <span class="btn-icon">⇠</span> Back
                </button>
            </div>
        </div>

        <div class="page-transition hidden" id="serviceSelectionSection">
            <div class="choice-grid">
                <div class="choice-card" data-choice="Pangolin">
                    <div class="choice-title">Pangolin</div>
                    <div class="choice-desc">High-load cluster</div>
                </div>
                <div class="choice-card" data-choice="Corax">
                    <div class="choice-title">Corax</div>
                    <div class="choice-desc">Standard cluster</div>
                </div>
            </div>
            <div class="form-actions" style="margin-top: 24px;">
                <button class="btn btn-secondary back-to-menu-btn" type="button">
                    <span class="btn-icon">⇠</span> Back
                </button>
            </div>
        </div>

        <div class="card hidden page-transition" id="formSection">
            <h1 class="section-title">Configuration</h1>
            <form class="test-form">
                <input type="hidden" class="choice-hidden" value="">
                <input type="hidden" class="cloud-project-id-hidden" value="{{ user_info.cloud_project_id }}">

                <div class="form-group">
                    <label class="form-label" for="subnet">Subnet Region</label>
                    <select id="subnet" class="input-field select-field subnet-select mono-font" required>
                        <option value="" disabled selected>Select subnet...</option>
                        <option value="10.10.10.0/24">10.10.10.0/24 (Production)</option>
                        <option value="172.0.0.0/24">172.17.0.0/24 (Staging)</option>
                        <option value="192.0.0.0/24">192.168.51.0/24 (Development)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="flavor">Instance Size</label>
                    <select id="flavor" class="input-field select-field flavor-select mono-font" required>
                        <option value="" disabled selected>Select flavor...</option>
                        <option value="2/4 30%">2 vCPU / 4 GB (Entry)</option>
                        <option value="4/8 30%">4 vCPU / 8 GB (Standard)</option>
                        <option value="8/16 30%">8 vCPU / 16 GB (Performance)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="title">Instance Alias</label>
                    <input id="title" type="text" class="input-field title-inp mono-font"
                        placeholder="e.g., web-node-01" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="desc">Description</label>
                    <input id="desc" type="text" class="input-field desc-inp mono-font" placeholder="Optional context">
                </div>

                <div class="form-actions">
                    <button class="btn btn-primary s-btn" type="button">
                        <span class="btn-icon">→</span> Initialize
                    </button>
                    <button class="btn btn-secondary back-to-services-btn" type="button">
                        <span class="btn-icon">⇠</span> Back
                    </button>
                </div>
            </form>
        </div>

        {% endif %}
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlertModal" class="custom-alert-modal hidden">
        <div class="custom-alert-overlay"></div>
        <div class="custom-alert-content">
            <div class="custom-alert-icon" id="alertIcon">!</div>
            <div class="custom-alert-message" id="alertMessage"></div>
            <button class="btn btn-primary custom-alert-btn" id="alertOkBtn">Acknowledge</button>
        </div>
    </div>

    <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>

</html>