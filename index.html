<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cloud Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://st.max.ru/js/max-web-app.js"></script>
</head>

<body>
    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, msg in messages %}
        <div class="alert {{ category }}">
            <span class="alert-icon">
                {% if category == 'success' %}‚úì
                {% elif category == 'error' %}!
                {% else %}‚Ñπ{% endif %}
            </span>
            {{ msg }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        {% if not is_authed %}
        <div class="app-header">
            <div class="app-logo">
                <img src="{{ url_for('static', filename='bot.png') }}" alt="App Logo">
            </div>
            <h1>Cloud Manager</h1>
            <div class="app-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–ª–∞—á–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π</div>
        </div>

        <!-- Unified Auth Container -->
        <div class="card auth-container page-transition active">

            <!-- 1. Keycloak Login Button -->
            <button class="btn btn-keycloak js-auth-btn convex-btn" type="button" data-provider="Keycloak"
                data-url="{{ url_for('keycloak_oauth_init') }}">
                <span class="btn-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" />
                    </svg>
                </span>
                –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Keycloak
            </button>

            <!-- 2. Electric Separator -->
            <div class="auth-separator">
                <span>–∏–ª–∏</span>
            </div>

            <!-- 3. Traditional Login Form -->
            <form action="{{ url_for('login') }}" method="POST">
                <div class="form-group">
                    <label class="form-label" for="login">–ª–æ–≥–∏–Ω</label>
                    <input id="login" name="login" type="text" class="input-field inset-input" placeholder="admin"
                        required autocomplete="username">
                </div>
                <div class="form-group">
                    <label class="form-label" for="password">–ø–∞—Ä–æ–ª—å</label>
                    <input id="password" name="password" type="password" class="input-field inset-input"
                        placeholder="pass" required autocomplete="current-password">
                </div>
                <button class="btn btn-primary convex-btn" type="submit">
                    <span class="btn-icon">‚Üí</span> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                </button>
            </form>
        </div>
        {% else %}
        <div class="app-header">
            <div class="app-logo">
                <img src="{{ url_for('static', filename='bot.png') }}" alt="App Logo">
            </div>
            <h1 id="headerTitle">–ú–µ–Ω—é</h1>
            <div class="app-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–ª–∞—á–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π</div>
        </div>

        <!-- 1. Main Menu Section -->
        <div class="page-transition active" id="menuSection">
            <div class="choice-grid">
                <div class="choice-card" data-action="resources">
                    <div class="choice-title">–†–µ—Å—É—Ä—Å—ã</div>
                    <div class="choice-desc">–≤ –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ</div>
                </div>
                <div class="choice-card" data-action="create">
                    <div class="choice-title">–°–æ–∑–¥–∞—Ç—å</div>
                    <div class="choice-desc">—Ä–µ—Å—É—Ä—Å</div>
                </div>
            </div>

            <div class="logout-container">
                <form action="{{ url_for('logout') }}" method="POST">
                    <button class="btn btn-secondary" type="submit">
                        <span class="btn-icon">‚á†</span> –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
                    </button>
                </form>
            </div>
        </div>

        <!-- 2. Resources Info Section -->
        <div class="card hidden page-transition" id="resourcesSection">
            <h1 style="font-size:24px;margin-bottom:16px;text-align:left">–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ</h1>
            <div class="user-info-container">
                <div class="form-group">
                    <label class="form-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <div class="info-value">{{ user_info.name }}</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <div class="info-value">{{ user_info.email }}</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Project ID</label>
                    <div class="info-value">{{ user_info.cloud_project_id }}</div>
                </div>
                <div class="form-group">
                    <label class="form-label">–í—Å–µ–≥–æ –í–ú</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <div class="info-value" id="vmCount" style="flex-grow: 1;">
                            <span class="spinner vm-spinner"></span>
                        </div>
                        <button class="btn btn-secondary btn-micro" id="refreshVmCountBtn" type="button">
                            <span class="btn-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M23 4v6h-6"></path>
                                    <path d="M1 20v-6h6"></path>
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15">
                                    </path>
                                </svg>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary back-to-menu-btn" type="button">
                    <span class="btn-icon">‚á†</span> –ù–∞–∑–∞–¥
                </button>
            </div>
        </div>

        <!-- 3. Service Selection Section (Previously mainSection) -->
        <div class="page-transition hidden" id="serviceSelectionSection">
            <div class="choice-grid">
                <div class="choice-card" data-choice="Pangolin">
                    <div class="choice-title">Pangolin</div>
                    <div class="choice-desc">–ö–ª–∞—Å—Ç–µ—Ä</div>
                </div>
                <div class="choice-card" data-choice="Corax">
                    <div class="choice-title">Corax</div>
                    <div class="choice-desc">–ö–ª–∞—Å—Ç–µ—Ä</div>
                </div>
            </div>
            <div class="form-actions" style="margin-top: 24px;">
                <button class="btn btn-secondary back-to-menu-btn" type="button">
                    <span class="btn-icon">‚á†</span> –ù–∞–∑–∞–¥
                </button>
            </div>
        </div>

        <!-- 4. Form Section -->
        <div class="card hidden page-transition" id="formSection">
            <h1 style="font-size:24px;margin-bottom:16px;text-align:left">–ó–∞–¥–∞–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h1>
            <form class="test-form">
                <input type="hidden" class="choice-hidden" value="">
                <input type="hidden" class="cloud-project-id-hidden" value="{{ user_info.cloud_project_id }}">

                <div class="form-group">
                    <label class="form-label" for="subnet">–ü–æ–¥—Å–µ—Ç—å</label>
                    <select id="subnet" class="input-field select-field subnet-select" required>
                        <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Å–µ—Ç—å</option>
                        <option value="10.10.10.0/24">10.10.10.0/24 (Production)</option>
                        <option value="172.0.0.0/24">172.17.0.0/24 (Staging)</option>
                        <option value="192.0.0.0/24">192.168.51.0/24 (Development)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="flavor">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</label>
                    <select id="flavor" class="input-field select-field flavor-select" required>
                        <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é</option>
                        <option value="2/4 30%">2 —è–¥—Ä–∞ / 4 –ì–ë RAM (30%)</option>
                        <option value="4/8 30%">4 —è–¥—Ä–∞ / 8 –ì–ë RAM (30%)</option>
                        <option value="8/16 30%">8 —è–¥–µ—Ä / 16 –ì–ë RAM (30%)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="title">–ù–∞–∑–≤–∞–Ω–∏–µ –í–ú</label>
                    <input id="title" type="text" class="input-field title-inp" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: web-server-prod"
                        required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="desc">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <input id="desc" type="text" class="input-field desc-inp" placeholder="–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞">
                </div>

                <div class="form-actions">
                    <button class="btn btn-primary s-btn" type="button">
                        <span class="btn-icon">‚Üí</span> –°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Ç–µ—Ä
                    </button>
                    <button class="btn btn-secondary back-to-services-btn" type="button">
                        <span class="btn-icon">‚á†</span> –ù–∞–∑–∞–¥
                    </button>
                </div>
            </form>
        </div>

        <!-- 5. Deployment Section (–ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–µ–ø–ª–æ—è) -->
        <div class="card hidden page-transition" id="deploymentSection">
            <!-- –•–µ–¥–µ—Ä —Å –ø—É–ª—å—Å–∞—Ü–∏–µ–π -->
            <div class="deploy-header">
                <div class="status-indicator-ring">
                    <div class="pulse-ring"></div>
                    <span class="status-icon" id="deployIcon">üöÄ</span>
                </div>
                <div class="deploy-title-group">
                    <h1 id="deployTitle" style="font-size: 20px; margin-bottom: 4px;">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</h1>
                    <div class="deploy-subtitle" id="deploySubtitle">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤</div>
                </div>
            </div>

            <!-- –ì–ª–∞–≤–Ω—ã–π Hero –ü—Ä–æ–≥—Ä–µ—Å—Å -->
            <div class="hero-progress-wrapper">
                <div class="hero-progress-bar" id="heroProgressBar" style="width: 0%"></div>
            </div>

            <!-- –¢–µ—Ä–º–∏–Ω–∞–ª (Geek UI) -->
            <div class="mini-terminal">
                <div class="terminal-header">
                    <span class="terminal-dot red"></span>
                    <span class="terminal-dot yellow"></span>
                    <span class="terminal-dot green"></span>
                </div>
                <div class="terminal-content">
                    <span class="prompt">$</span> <span id="terminalText">Waiting for pipeline agent...</span><span
                        class="cursor">_</span>
                </div>
            </div>

            <!-- –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –¢–∞–π–º–ª–∞–π–Ω -->
            <div class="timeline-container" id="deployTimeline">
                <!-- –°—é–¥–∞ JS –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ç–∞–ø—ã -->
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="form-actions" id="deployActions">
                <button class="btn btn-secondary" id="hideDeployBtn" type="button">
                    <span class="btn-icon">√ó</span> –°–≤–µ—Ä–Ω—É—Ç—å –≤ —Ñ–æ–Ω
                </button>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlertModal" class="custom-alert-modal hidden">
        <div class="custom-alert-overlay"></div>
        <div class="custom-alert-content">
            <div class="custom-alert-icon" id="alertIcon">!</div>
            <div class="custom-alert-message" id="alertMessage"></div>
            <button class="btn btn-primary custom-alert-btn" id="alertOkBtn">OK</button>
        </div>
    </div>

    <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>

</html>